# Test Spec Analysis & Refactoring Recommendations

## Overview
Analysis of the Underpass Ruby gem test suite, identifying issues and providing refactoring recommendations.

---

## Critical Issues

### 1. spec_helper.rb - Excessive Boilerplate & Dead Code

**File:** [`spec/spec_helper.rb`](spec/spec_helper.rb:1)

**Issues:**
- **Lines 16-28:** Outdated comment about being generated by `rspec --init` (not relevant anymore)
- **Lines 35-43:** Outdated comment about RSpec 4 default behavior
- **Lines 48-52:** Outdated comment about RSpec 4 default behavior
- **Lines 55-60:** Outdated comment about RSpec 4 default behavior
- **Lines 70-113:** 44 lines of commented-out configuration options that should either be enabled or removed
- The file is 114 lines but only ~30 lines are active configuration

**Impact:**
- Confusing for maintainers
- Suggests incomplete configuration decisions
- Wastes mental energy on dead code

**Recommendation:**
Remove all commented-out code and outdated comments. Keep only active configuration. Consider enabling useful options like random order execution and warnings.

---

### 2. spec/underpass/ql/query_spec.rb - Incorrect Context Nesting

**File:** [`spec/underpass/ql/query_spec.rb`](spec/underpass/ql/query_spec.rb:63)

**Issue:**
```ruby
describe '#perform' do
  # ... contexts for closed way and open way ...
end

context 'when a node is returned' do  # Line 63 - WRONG NESTING
```

The `context 'when a node is returned'` is at the wrong indentation level. It should be inside `describe '#perform'`.

**Impact:**
- Confusing test structure
- Makes it unclear that this context is also testing the `#perform` method

**Recommendation:**
Move the context inside `describe '#perform'` for proper nesting.

---

### 3. spec/underpass/shape_spec.rb - Inconsistent Subject Usage

**File:** [`spec/underpass/shape_spec.rb`](spec/underpass/shape_spec.rb:8)

**Issue:**
```ruby
describe Underpass::Shape do
  subject { described_class }  # Line 8 - class as subject

  describe '#open_way?' do
    subject { described_class.open_way?(way) }  # Line 13 - redefined as method result
```

The subject is redefined inconsistently, making it confusing which subject is being used.

**Impact:**
- Confusing test code
- Violates principle of least surprise

**Recommendation:**
Remove the outer `subject { described_class }` since it's never used. Or use explicit `expect` calls instead of relying on `subject`.

---

## Moderate Issues

### 4. spec/underpass/client_spec.rb - Unclear Stub Usage

**File:** [`spec/underpass/client_spec.rb`](spec/underpass/client_spec.rb:14)

**Issue:**
```ruby
stub = stub_request(:post, 'https://overpass-api.de/api/interpreter')
       .with(body: /#{bbox}/)
subject.perform(request_double)
expect(stub).to have_been_requested
```

The stub is created but the test doesn't verify the full request body, only that it contains `bbox`. The `request_double` is mocked but its actual query isn't verified.

**Impact:**
- Test doesn't fully verify the behavior
- Could miss bugs in query construction

**Recommendation:**
Verify the complete query string or use a more specific matcher.

---

### 5. spec/underpass/matcher_spec.rb - Repetitive Test Structure

**File:** [`spec/underpass/matcher_spec.rb`](spec/underpass/matcher_spec.rb:1)

**Issue:**
The test structure is highly repetitive:
- Lines 28-32: Test for nodes with tags
- Lines 48-52: Test for polygon ways
- Lines 64-68: Test for line string ways
- Lines 93-96: Test for relation members as nodes
- Lines 117-120: Test for relation members as ways

All follow the same pattern: mock Shape method, expect it to be called N times, verify match count.

**Impact:**
- Duplicated code
- Harder to maintain
- Violates DRY principle

**Recommendation:**
Extract common patterns into shared examples or helper methods.

---

### 6. spec/underpass/ql/request_spec.rb - Implementation Testing

**File:** [`spec/underpass/ql/request_spec.rb`](spec/underpass/ql/request_spec.rb:14)

**Issue:**
```ruby
describe '#initialize' do
  it 'sets the correct instance variables' do
    expect(subject.instance_variable_get(:@overpass_query)).to eq(query)
    expect(subject.instance_variable_get(:@global_bbox)).to eq("[#{bbox}]")
  end
end
```

Tests private implementation details using `instance_variable_get`.

**Impact:**
- Brittle tests that break with internal refactoring
- Tests implementation, not behavior

**Recommendation:**
Test public behavior instead. For `#initialize`, test the output of `#to_query` which depends on initialization.

---

### 7. spec/underpass/ql/response_spec.rb - Implementation Testing

**File:** [`spec/underpass/ql/response_spec.rb`](spec/underpass/ql/response_spec.rb:18)

**Issue:**
```ruby
describe '#initialize' do
  it 'sets the correct instance variable' do
    allow(JSON).to receive(:parse).and_return(elements: elements)
    expect(subject.instance_variable_get(:@elements)).to eq(elements)
  end
end
```

Same issue as request_spec.rb - testing private implementation.

**Impact:**
- Brittle tests
- Tests implementation, not behavior

**Recommendation:**
Test the public methods (`#nodes`, `#ways`, `#relations`) which depend on initialization.

---

## Minor Issues

### 8. spec/underpass/ql/request_spec.rb - Redundant Line

**File:** [`spec/underpass/ql/request_spec.rb`](spec/underpass/ql/request_spec.rb:19)

**Issue:**
```ruby
@global_bbox ||= "[#{bbox}]"  # ||= is unnecessary since this is initialization
```

**Impact:**
- Slightly confusing - suggests memoization where none exists

**Recommendation:**
Change to `@global_bbox = "[#{bbox}]"` for clarity.

---

### 9. Missing Edge Cases

**Observation:**
The tests don't cover several edge cases:
- Empty responses
- Malformed JSON responses
- Network errors
- Missing required fields in nodes/ways/relations
- Empty tags

**Impact:**
- Reduced confidence in error handling

**Recommendation:**
Consider adding tests for error cases, though this may be out of scope for a refactoring task.

---

## Refactoring Recommendations Summary

### High Priority (Should Fix)

1. **Clean up spec_helper.rb** - Remove all commented-out code and outdated comments
2. **Fix query_spec.rb nesting** - Move the node context inside `describe '#perform'`
3. **Fix shape_spec.rb subject** - Remove inconsistent subject redefinition

### Medium Priority (Should Consider)

4. **Improve client_spec.rb** - Add more specific request body verification
5. **Reduce matcher_spec.rb duplication** - Extract common patterns
6. **Remove implementation testing** - Replace `instance_variable_get` with behavior testing

### Low Priority (Nice to Have)

7. **Fix request_spec.rb redundant operator** - Change `||=` to `=`
8. **Add edge case tests** - Consider testing error scenarios

---

## Proposed Refactored Structure

### spec_helper.rb (simplified)
```ruby
# frozen_string_literal: true

require 'simplecov'
SimpleCov.start do
  add_filter '/spec/'
end

require 'coveralls' if ENV['CI'] == 'true'
Coveralls.wear! if ENV['CI'] == 'true'

require 'webmock/rspec'

RSpec.configure do |config|
  config.expect_with :rspec do |expectations|
    expectations.include_chain_clauses_in_custom_matcher_descriptions = true
  end

  config.mock_with :rspec do |mocks|
    mocks.verify_partial_doubles = true
  end

  config.shared_context_metadata_behavior = :apply_to_host_groups

  # Enable random order to surface order dependencies
  config.order = :random
  Kernel.srand config.seed
end
```

### query_spec.rb (fixed nesting)
```ruby
describe '#perform' do
  context 'when a closed way is returned' do
    # ...
  end

  context 'when an open way is returned' do
    # ...
  end

  context 'when a node is returned' do
    # ... (moved inside)
  end
end
```

### shape_spec.rb (fixed subject)
```ruby
describe Underpass::Shape do
  describe '.open_way?' do
    subject { described_class.open_way?(way) }
    # ...
  end
end
```

### request_spec.rb (behavior testing)
```ruby
describe '#to_query' do
  it 'generates the correct query string' do
    expect(subject.to_query).to eq(expected_query)
  end
end
```

---

## Conclusion

The test suite is generally well-structured but has several areas for improvement:

1. **Dead code removal** would significantly improve maintainability
2. **Fixing structural issues** (nesting, subject usage) would improve clarity
3. **Reducing duplication** would make tests easier to maintain
4. **Testing behavior over implementation** would make tests more robust

The changes are relatively straightforward and would improve the overall quality of the test suite without requiring significant rewrites.
